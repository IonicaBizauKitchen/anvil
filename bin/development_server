#!/usr/bin/env ruby

require "distributor/server"

`stty -echo raw`

server = Distributor::Server.new($stdin.dup, $stdout.dup)
$stdout.reopen($stderr)

server.on_command do |command, data|
  Thread.new do
    case command
    when "file.download" then
      file = File.expand_path(File.join("/app/work", data["name"]))
      FileUtils.mkdir_p File.dirname(file)
      %x{ curl -s #{ENV["ANVIL_HOST"]}/file/#{data["hash"]} -o #{file} 2>&1 }
      server.command command, data.merge("ack" => Time.now.to_f)
    when "file.delete" then
      file = File.expand_path(File.join("/app/work", data["name"]))
      FileUtils.rm_f file
      server.command command, data.merge("ack" => Time.now.to_f)
    end
  end
end

server.start
